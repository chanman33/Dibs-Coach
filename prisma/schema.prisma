generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum TicketStatus {
  open
  in_progress
  closed
}

enum UserStatus {
  active
  inactive
  suspended
}

enum SessionStatus {
  scheduled
  completed
  cancelled
  no_show
}

enum Currency {
  USD
  EUR
  GBP
}

enum PaymentMethod {
  credit_card
  debit_card
  bank_transfer
}

enum PayoutStatus {
  pending
  processed
  failed
}

enum RefundStatus {
  pending
  completed
  failed
}

enum DisputeStatus {
  open
  resolved
  rejected
}

enum GoalStatus {
  in_progress
  completed
  overdue
}

enum GoalType {
  // Financial Goals
  sales_volume
  commission_income
  gci
  avg_sale_price
  
  // Transaction Goals
  listings
  buyer_transactions
  closed_deals
  days_on_market
  
  // Coaching & Mentorship Goals
  coaching_sessions
  group_sessions
  session_revenue
  active_mentees
  mentee_satisfaction
  response_time
  session_completion
  mentee_milestones
  
  // Client Goals
  new_clients
  referrals
  client_retention
  reviews
  
  // Market Presence
  market_share
  territory_expansion
  social_media
  website_traffic
  
  // Professional Development
  certifications
  training_hours
  networking_events
  
  // Other
  custom
}

enum AchievementType {
  milestone
  performance
  learning
}

enum UserRole {
  MENTEE
  COACH
  ADMIN
}

enum SessionType {
  PEER_TO_PEER
  MENTORSHIP
  GROUP
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  HIDDEN
}

enum CoachApplicationStatus {
  pending
  approved
  rejected
}

enum Role {
  USER
  COACH
  ADMIN
}

enum Status {
  ACTIVE
  INACTIVE
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ActivityType {
  USER
  COACH
  SYSTEM
  SECURITY
}

enum ActivitySeverity {
  INFO
  WARNING
  ERROR
}

enum ListingStatus {
  Active
  ActiveUnderContract
  Canceled
  Closed
  ComingSoon
  Delete
  Expired
  Hold
  Incomplete
  Pending
  Withdrawn
}

enum PropertyType {
  BusinessOpportunity
  CommercialLease
  CommercialSale
  Farm
  Land
  ManufacturedInPark
  Residential
}

enum PropertySubType {
  // Residential subtypes
  Apartment
  Cabin
  Condominium
  Duplex
  ManufacturedHome
  SingleFamilyDetached
  SingleFamilyAttached
  Mobile
  Townhouse
  Triplex
  Quadruplex
  
  // Commercial subtypes
  Hotel
  CommercialIndustrial
  CommercialMixedUse
  MultiFamily
  Office
  Retail
  Restaurant
  Warehouse
  
  // Land subtypes
  AgriculturalLand
  CommercialLand
  IndustrialLand
  LandMixedUse
  ResidentialLand
  
  // Farm subtypes
  Equestrian
  Ranch
  TimberLand
  Vineyard
  
  // Business Opportunity subtypes
  BusinessOnly
  BusinessWithProperty
  BusinessWithRealEstate
  
  // ManufacturedInPark subtypes
  DoubleWide
  SingleWide
  TripleWide
  
  // Other
  Other
}

enum FurnishedStatus {
  Furnished
  Negotiable
  Partially
  Unfurnished
}

enum PropertyCondition {
  Excellent
  Good
  Fair
  NeedsWork
  Renovated
  Updated
}

enum ListingTerms {
  Cash
  Conventional
  FHA
  OwnerFinancing
  VA
}

enum ListingAgreement {
  Exclusive
  OpenListing
  PocketListing
}

// Add new enums for RESO compliance
enum ArchitecturalStyle {
  Colonial
  Contemporary
  Craftsman
  Mediterranean
  Modern
  Ranch
  Traditional
  Victorian
}

enum BasementType {
  Finished
  Partially
  Unfinished
  None
}

enum RoofType {
  Asphalt
  Metal
  Slate
  Tile
  Wood
}

enum ViewType {
  City
  Golf
  Lake
  Mountain
  Ocean
  Park
  River
  Woods
}

// Models
model User {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userId                 String   @unique // Clerk ID
  email                  String   @unique
  firstName              String?
  lastName               String?
  displayName            String?
  role                   String   @default("MENTEE")
  stripeCustomerId       String?  @unique
  stripeConnectAccountId String?  @unique
  createdAt              DateTime @default(now()) @db.Timestamptz
  updatedAt              DateTime @updatedAt @db.Timestamptz

  // RESO Member fields
  memberKey             String?  @unique
  memberStatus          String
  designations          String[]
  licenseNumber         String?  @unique
  companyName           String?
  phoneNumber           String?

  // Application-specific fields
  status               UserStatus @default(active)
  profileImageUrl      String?

  // Profile Relations
  realtorProfile       RealtorProfile?
  menteeProfile        MenteeProfile?
  coachProfile         CoachProfile?

  // Existing integrations
  calendlyIntegration CalendlyIntegration?
  coachingSchedules   CoachingAvailabilitySchedule[]

  // Session Relations
  sessions             Session[]               @relation("UserSessions")
  coachingSessions     Session[]               @relation("CoachSessions")
  paymentMethods       StripePaymentMethod[]
  setupIntents         SetupIntent[]
  stripeAccount        StripeConnectedAccount?
  sentTransactions     Transaction[]           @relation("TransactionPayer")
  receivedTransactions Transaction[]           @relation("TransactionCoach")

  // Keep existing relations
  paymentsMade     Payment[]     @relation("Payer")
  paymentsReceived Payment[]     @relation("Payee")
  payouts          Payout[]      @relation("PayoutPayee")
  reviewsGiven     Review[]      @relation("Reviewer")
  reviewsReceived  Review[]      @relation("Reviewee")
  goals            Goal[]
  achievements     Achievement[]

  // Message Relations
  messagesSent     Message[] @relation("Sender")
  messagesReceived Message[] @relation("Recipient")
  aiThreads        AIThread[]

  // Referral Relations
  referralsGiven    Referral[] @relation("Referrer")
  referralsReceived Referral[] @relation("Referee")

  // Other Relations
  applications         CoachApplication[] @relation("Applicant")
  reviewedApplications CoachApplication[] @relation("Reviewer")
  authoredNotes        Note[]             @relation("AuthorNotes")
  relatedNotes         Note[]             @relation("RelatedUserNotes")
  reminders            Reminder[]
  supportTickets       SupportTicket[]    @relation("UserSupportTickets")
  subscriptions        Subscription[]
  invoices             Invoice[]
  calendlyEvents       CalendlyEvent[]

  // Admin relations
  adminAuditLogs       AdminAuditLog[]    @relation("AdminAuditLogs")

  @@index([userId])
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("User")
}

// Base profile for all realtors (both coaches and mentees)
model RealtorProfile {
  ulid              String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid          String   @unique @db.Char(26)
  bio               String?
  yearsExperience   Int?
  
  // Professional Information
  propertyTypes     String[]
  specializations   String[]
  certifications    String[]
  languages         String[]
  
  // Geographic Focus
  geographicFocus   Json
  primaryMarket     String?

  // Marketing Information
  slogan            String?
  websiteUrl        String?
  facebookUrl       String?
  instagramUrl      String?
  linkedinUrl       String?
  youtubeUrl        String?
  marketingAreas    String[]
  testimonials      Json

  // Relations
  user              User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)
  listings          Listing[]
  professionalRecognitions ProfessionalRecognition[]

  // MLS Integration fields
  mlsId             String?  @unique
  mlsName           String?
  mlsStatus         String?

  createdAt         DateTime @default(now()) @db.Timestamptz
  updatedAt         DateTime @updatedAt @db.Timestamptz

  @@index([userUlid])
  @@map("RealtorProfile")
}

// Mentee-specific profile data
model MenteeProfile {
  ulid              String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid          String   @unique @db.Char(26)
  focusAreas        String[]
  experienceLevel   String?
  learningStyle     String?
  goals             Json?
  sessionsCompleted Int      @default(0)
  isActive          Boolean  @default(true)
  lastSessionDate   DateTime?

  // Relations
  user              User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)

  createdAt         DateTime @default(now()) @db.Timestamptz
  updatedAt         DateTime @updatedAt @db.Timestamptz

  @@index([userUlid])
  @@map("MenteeProfile")
}

// Coach-specific profile data
model CoachProfile {
  ulid                String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid            String   @unique @db.Char(26)
  coachingSpecialties String[]
  yearsCoaching       Int?
  hourlyRate          Decimal? @db.Decimal(10, 2)

  // Calendly Integration
  calendlyUrl         String?
  eventTypeUrl        String?

  // Session Configuration
  isActive            Boolean  @default(true)
  defaultDuration     Int      @default(60)
  allowCustomDuration Boolean  @default(false)
  minimumDuration     Int      @default(30)
  maximumDuration     Int      @default(120)
  totalSessions       Int      @default(0)
  averageRating       Decimal? @db.Decimal(3, 2)

  // Relations
  user               User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)

  createdAt          DateTime @default(now()) @db.Timestamptz
  updatedAt          DateTime @updatedAt @db.Timestamptz

  @@index([userUlid])
  @@map("CoachProfile")
}

model Session {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  menteeUlid             String   @db.Char(26)
  coachUlid              String   @db.Char(26)
  startTime              DateTime @db.Timestamptz
  endTime                DateTime @db.Timestamptz
  status                 SessionStatus @default(scheduled)
  sessionType            SessionType?
  sessionNotes           String?
  zoomMeetingId          String?
  zoomMeetingUrl         String?

  // Payment fields
  priceAmount            Float?
  currency               String? @default("usd")
  platformFeeAmount      Float?
  coachPayoutAmount      Float?
  stripePaymentIntentId  String?
  paymentStatus          String? @default("pending")
  payoutStatus           String?

  // Relationships
  mentee                 User           @relation("UserSessions", fields: [menteeUlid], references: [ulid])
  coach                  User           @relation("CoachSessions", fields: [coachUlid], references: [ulid])
  transaction            Transaction?
  payment                Payment?       @relation("SessionPayment")
  reviews                Review[]
  notes                  Note[]
  reminders              Reminder[]
  calendlyEvent          CalendlyEvent? @relation("SessionCalendlyEvent")
  zoomSession            ZoomSession?
  disputes               Dispute[]      @relation("SessionDisputes")

  createdAt              DateTime @default(now()) @db.Timestamptz
  updatedAt              DateTime @updatedAt @db.Timestamptz

  @@index([menteeUlid])
  @@index([coachUlid])
  @@map("Session")
}

model Payment {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  sessionUlid            String?  @unique @db.Char(26)
  payerUlid              String   @db.Char(26)
  payeeUlid              String   @db.Char(26)
  amount                 Decimal  @db.Decimal(10, 2)
  currency               Currency @default(USD)
  status                 PaymentStatus @default(pending)
  stripePaymentId        String?

  session                Session? @relation("SessionPayment", fields: [sessionUlid], references: [ulid])
  payer                  User     @relation("Payer", fields: [payerUlid], references: [ulid])
  payee                  User     @relation("Payee", fields: [payeeUlid], references: [ulid])
  disputes               Dispute[] @relation("PaymentDisputes")
  chargebacks            Chargeback[]
  refunds                Refund[]

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([sessionUlid])
  @@index([payerUlid])
  @@index([payeeUlid])
}

model Review {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  reviewerUlid           String   @db.Char(26)
  revieweeUlid           String   @db.Char(26)
  sessionUlid            String?  @db.Char(26)
  rating                 Int
  comment                String?
  status                 String   @default("published")
  isVerified             Boolean  @default(false)

  reviewer               User     @relation("Reviewer", fields: [reviewerUlid], references: [ulid], onDelete: Cascade)
  reviewee               User     @relation("Reviewee", fields: [revieweeUlid], references: [ulid], onDelete: Cascade)
  session                Session? @relation(fields: [sessionUlid], references: [ulid], onDelete: SetNull)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([reviewerUlid])
  @@index([revieweeUlid])
  @@index([sessionUlid])
}

model CoachApplication {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  applicantUlid          String   @db.Char(26)
  status                 CoachApplicationStatus @default(pending)
  experience             String
  specialties            String[] @default([])
  applicationDate        DateTime @default(now())
  reviewerUlid           String?  @db.Char(26)
  reviewDate             DateTime?
  notes                  String?
  
  // Draft-specific fields
  isDraft                Boolean   @default(false)
  lastSavedAt            DateTime? @db.Timestamptz
  draftData              Json?
  draftVersion           Int       @default(1)
  
  // Application fields
  resumeUrl              String?
  linkedIn               String?
  primarySocialMedia     String?
  additionalInfo         String?

  applicant              User     @relation("Applicant", fields: [applicantUlid], references: [ulid], onDelete: Cascade)
  reviewer               User?    @relation("Reviewer", fields: [reviewerUlid], references: [ulid], onDelete: SetNull)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([applicantUlid])
  @@index([reviewerUlid])
  @@index([isDraft, applicantUlid])
}

model Note {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  authorUlid             String   @db.Char(26)
  relatedUserUlid        String?  @db.Char(26)
  sessionUlid            String?  @db.Char(26)
  content                String
  visibility             String   @default("private")

  author                 User     @relation("AuthorNotes", fields: [authorUlid], references: [ulid], onDelete: Cascade)
  relatedUser            User?    @relation("RelatedUserNotes", fields: [relatedUserUlid], references: [ulid], onDelete: SetNull)
  session                Session? @relation(fields: [sessionUlid], references: [ulid], onDelete: SetNull)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([authorUlid])
  @@index([relatedUserUlid])
  @@index([sessionUlid])
}

model SupportTicket {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  title                  String
  description            String
  status                 TicketStatus @default(open)

  user                   User     @relation("UserSupportTickets", fields: [userUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userUlid])
}

model Payout {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  payeeUlid              String   @db.Char(26)
  amount                 Decimal  @db.Decimal(10, 2)
  currency               String   @default("USD")
  stripeTransferId       String?
  status                 PayoutStatus @default(pending)
  scheduledDate          DateTime
  processedAt            DateTime?

  payee                  User     @relation("PayoutPayee", fields: [payeeUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([payeeUlid])
}

model Dispute {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  stripeDisputeId        String   @unique
  sessionUlid            String?  @db.Char(26)
  session                Session? @relation("SessionDisputes", fields: [sessionUlid], references: [ulid], onDelete: SetNull)
  amount                 Int
  currency               String
  status                 String
  reason                 String
  evidenceDueBy          DateTime
  evidence               Json
  stripePaymentIntentId  String
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Payment relation
  paymentUlid            String?  @db.Char(26)
  payment                Payment? @relation("PaymentDisputes", fields: [paymentUlid], references: [ulid], onDelete: SetNull)

  @@index([sessionUlid])
  @@index([stripeDisputeId])
  @@map("Dispute")
}

model Chargeback {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  paymentUlid            String   @db.Char(26)
  reason                 String?
  status                 String   @default("open")

  payment                Payment  @relation(fields: [paymentUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([paymentUlid])
}

model Refund {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  paymentUlid            String   @db.Char(26)
  reason                 String?
  status                 RefundStatus @default(pending)

  payment                Payment  @relation(fields: [paymentUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([paymentUlid])
}

model Message {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  senderUlid             String   @db.Char(26)
  recipientUlid          String   @db.Char(26)
  content                String
  readStatus             String   @default("unread")
  sentAt                 DateTime @default(now())

  sender                 User     @relation("Sender", fields: [senderUlid], references: [ulid], onDelete: Cascade)
  recipient              User     @relation("Recipient", fields: [recipientUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([senderUlid])
  @@index([recipientUlid])
}

model Referral {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  referrerUlid           String   @db.Char(26)
  refereeUlid            String   @db.Char(26)
  referralCode           String   @unique
  status                 String   @default("pending")

  referrer               User     @relation("Referrer", fields: [referrerUlid], references: [ulid], onDelete: Cascade)
  referee                User     @relation("Referee", fields: [refereeUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([referrerUlid])
  @@index([refereeUlid])
}

model Reminder {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  sessionUlid            String?  @db.Char(26)
  message                String
  remindAt               DateTime
  status                 String   @default("pending")

  user                   User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)
  session                Session? @relation(fields: [sessionUlid], references: [ulid], onDelete: SetNull)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userUlid])
  @@index([sessionUlid])
}

model CalendlyIntegration {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @unique @db.Char(26)
  user                   User     @relation(fields: [userUlid], references: [ulid])
  userId                 String    // Calendly user ID
  eventTypeId            String?   // Default event type ID
  accessToken            String
  refreshToken           String
  scope                  String
  organization           String?   // Organization ID
  expiresAt              DateTime  @db.Timestamptz
  lastSyncAt             DateTime? @db.Timestamptz
  failedRefreshCount     Int       @default(0)
  status                 String    @default("active")
  schedulingUrl          String    // Personal scheduling URL
  organizationUrl        String?   // Optional - only for org accounts
  createdAt              DateTime  @default(now()) @db.Timestamptz
  updatedAt              DateTime  @updatedAt @db.Timestamptz

  @@index([userUlid])
  @@map("CalendlyIntegration")
}

model Subscription {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  subscriptionId         String   @unique
  userUlid               String   @db.Char(26)
  stripeCustomerId       String
  status                 String
  startDate              DateTime
  endDate                DateTime?
  planUlid               String   @db.Char(26)
  defaultPaymentMethodId String?

  user                   User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)
  plan                   SubscriptionPlan @relation(fields: [planUlid], references: [ulid], onDelete: Restrict)
  invoices               Invoice[]

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userUlid])
  @@index([planUlid])
}

model SubscriptionPlan {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  planId                 String   @unique
  name                   String
  description            String
  amount                 Decimal  @db.Decimal(10, 2)
  currency               String   @default("USD")
  interval               String
  isActive               Boolean  @default(true)

  subscriptions          Subscription[]

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model Invoice {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  invoiceId              String   @unique
  subscriptionId         String
  userUlid               String?  @db.Char(26)
  amountPaid             Decimal  @db.Decimal(10, 2)
  amountDue              Decimal? @db.Decimal(10, 2)
  currency               String
  status                 String
  dueDate                DateTime?

  subscription           Subscription? @relation(fields: [subscriptionId], references: [subscriptionId], onDelete: SetNull)
  user                   User?        @relation(fields: [userUlid], references: [ulid], onDelete: SetNull)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([subscriptionId])
  @@index([userUlid])
}

model CalendlyWebhookEvent {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  eventType              String
  payload                Json
  processed              Boolean  @default(false)
  error                  String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([eventType])
  @@index([processed])
}

model CalendlyEvent {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  eventUuid              String   @unique
  userUlid               String   @db.Char(26)
  status                 String
  eventType              String
  inviteeEmail           String
  inviteeName            String
  sessionUlid            String?  @unique @db.Char(26)

  // Relationships
  session                Session? @relation("SessionCalendlyEvent", fields: [sessionUlid], references: [ulid])
  user                   User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userUlid])
  @@index([eventUuid])
}

model ZoomSession {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  sessionUlid            String   @unique @db.Char(26)
  topic                  String
  status                 String
  joinUrl                String?

  // Relationships
  session                Session  @relation(fields: [sessionUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([sessionUlid])
}

model Goal {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  title                  String
  description            String?
  target                 Float
  current                Float      @default(0)
  deadline               DateTime
  type                   GoalType
  status                 GoalStatus @default(in_progress)

  // Relationships
  user                   User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)

  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([userUlid])
  @@index([type])
  @@index([status])
}

// Application-specific achievements
model Achievement {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  type                   String   // e.g., "SESSION_MILESTONE", "RATING_MILESTONE"
  milestone              String   // e.g., "10_SESSIONS", "100_FIVE_STAR_REVIEWS"
  earnedAt               DateTime @default(now()) @db.Timestamptz
  metadata               Json?    // Additional achievement-specific data

  user                   User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime @default(now()) @db.Timestamptz
  updatedAt              DateTime @updatedAt @db.Timestamptz

  @@index([userUlid])
  @@index([type])
  @@map("Achievement")
}

// Professional recognition (formerly stored in RealtorProfile.achievements)
model ProfessionalRecognition {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  realtorProfileUlid     String   @db.Char(26)
  title                  String
  type                   RecognitionType
  year                   Int
  organization           String?
  description            String?
  
  realtorProfile         RealtorProfile @relation(fields: [realtorProfileUlid], references: [ulid], onDelete: Cascade)

  createdAt              DateTime  @default(now()) @db.Timestamptz
  updatedAt              DateTime  @updatedAt @db.Timestamptz
  archivedAt             DateTime? @db.Timestamptz

  @@index([realtorProfileUlid])
  @@index([type])
  @@map("ProfessionalRecognition")
}

enum RecognitionType {
  AWARD        // e.g., "Top Producer Award"
  ACHIEVEMENT  // e.g., "Sold $10M in Properties"
}

model CoachingAvailabilitySchedule {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  name                   String // e.g., "Standard Schedule", "Holiday Hours"
  timezone               String
  isDefault              Boolean  @default(false)
  active                 Boolean  @default(true)

  // Session Configuration
  defaultDuration        Int     @default(60)
  minimumDuration          Int     @default(30)
  maximumDuration          Int     @default(120)
  allowCustomDuration      Boolean @default(false)
  bufferBefore             Int     @default(15) // minutes
  bufferAfter              Int     @default(15) // minutes

  // Availability Rules
  rules                  Json // Stored as JSONB - weekly schedule, breaks, etc.

  // Integration Settings
  calendlyEnabled          Boolean @default(false)
  zoomEnabled              Boolean @default(false)

  // Metrics
  totalSessions            Int      @default(0)
  averageRating            Decimal? @db.Decimal(3, 2)

  user                     User     @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)

  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([userUlid])
}

model StripePaymentMethod {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  stripePaymentMethodId  String
  type                   String // card, bank_account
  isDefault              Boolean  @default(false)
  metadata               Json     @default("{}")
  createdAt              DateTime @default(now()) @db.Timestamptz
  updatedAt              DateTime @updatedAt @db.Timestamptz

  // Relationships
  user                   User     @relation(fields: [userUlid], references: [ulid])

  @@unique([userUlid, stripePaymentMethodId])
  @@index([userUlid])
  @@map("StripePaymentMethod")
}

model SetupIntent {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  stripeSetupIntentId    String
  status                 String
  createdAt              DateTime @default(now()) @db.Timestamptz
  updatedAt              DateTime @updatedAt @db.Timestamptz

  // Relationships
  user                   User     @relation(fields: [userUlid], references: [ulid])

  @@index([userUlid])
  @@map("SetupIntent")
}

model StripeConnectedAccount {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @unique @db.Char(26)
  stripeAccountId        String   @unique
  country                String
  defaultCurrency        String    @default("usd")
  payoutsEnabled         Boolean   @default(false)
  detailsSubmitted       Boolean   @default(false)
  chargesEnabled         Boolean   @default(false)
  requiresOnboarding     Boolean   @default(true)
  deauthorizedAt         DateTime? @db.Timestamptz
  createdAt              DateTime  @default(now()) @db.Timestamptz
  updatedAt              DateTime  @updatedAt @db.Timestamptz

  // Relationships
  user                   User     @relation(fields: [userUlid], references: [ulid])

  @@map("StripeConnectedAccount")
}

model Transaction {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  type                   String // session_payment, bundle_payment, payout, refund
  status                 String // pending, completed, failed, refunded
  amount                 Float
  currency               String   @default("usd")
  stripePaymentIntentId  String?
  stripeTransferId       String?
  platformFee            Float?
  coachPayout            Float?
  sessionUlid            String?  @unique @db.Char(26)
  payerUlid              String   @db.Char(26)
  coachUlid              String   @db.Char(26)
  metadata               Json     @default("{}")
  createdAt              DateTime @default(now()) @db.Timestamptz
  updatedAt              DateTime @updatedAt @db.Timestamptz

  // Relationships
  session                Session? @relation(fields: [sessionUlid], references: [ulid])
  payer                  User       @relation("TransactionPayer", fields: [payerUlid], references: [ulid])
  coach                  User       @relation("TransactionCoach", fields: [coachUlid], references: [ulid])

  @@index([payerUlid])
  @@index([coachUlid])
  @@index([sessionUlid])
  @@map("Transaction")
}

model SystemHealth {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  status                 Int
  activeSessions         Int
  pendingReviews         Int
  securityAlerts         Int
  uptime                 Float
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  @@index([createdAt])
  @@map("SystemHealth")
}

model AdminMetrics {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  totalUsers             Int
  activeUsers            Int
  totalCoaches           Int
  activeCoaches          Int
  pendingCoaches         Int
  totalSessions          Int
  completedSessions      Int
  totalRevenue           Float
  monthlyRevenue         Float
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  @@index([createdAt])
  @@map("AdminMetrics")
}

model SystemActivity {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  type                   String    // Enum in application layer
  title                  String
  description            String
  severity               String?   // Optional enum in application layer
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  @@index([type, createdAt])
  @@index([severity, createdAt])
  @@map("SystemActivity")
}

model SystemAlerts {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  type                   String    // Enum in application layer
  title                  String
  message                String
  severity               String    // Enum in application layer
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  @@index([type, createdAt])
  @@index([severity, createdAt])
  @@map("SystemAlerts")
}

// Admin Dashboard MVP Models
model AdminActivity {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  type                   String    // USER_ACTION, COACH_APPLICATION, SESSION, SYSTEM
  title                  String
  description            String
  userUlid               String?  @db.Char(26)
  severity               String    // LOW, MEDIUM, HIGH
  createdAt              DateTime @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @db.Timestamptz(6)

  @@index([type])
  @@index([createdAt])
  @@map("AdminActivity")
}

// Keep track of important admin actions for audit
model AdminAuditLog {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  adminUlid              String   @db.Char(26)
  admin                  User     @relation("AdminAuditLogs", fields: [adminUlid], references: [ulid])
  action                 String    // Type of action performed
  targetType             String    // What was affected (user, coach, application, etc)
  targetUlid             String   @db.Char(26)
  details                Json      // Additional details about the action
  createdAt              DateTime @default(now()) @db.Timestamptz(6)

  @@index([adminUlid])
  @@index([action])
  @@index([createdAt])
  @@map("AdminAuditLog")
}

// New Listing model with RESO compliance
model Listing {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  // Core Identification (RESO format)
  listingKey             String?       @unique  // RESO: Unique identifier for MLS integration
  parcelNumber           String?       @db.VarChar(50)  // RESO: Official parcel/tax ID
  taxLot                 String?       @db.VarChar(50)  // RESO: Tax lot number
  taxBlock               String?       @db.VarChar(50)  // RESO: Tax block number
  taxMapNumber           String?       @db.VarChar(50)  // RESO: Tax map reference
  taxLegalDescription    String?     @db.VarChar(1000) // RESO: Full legal description
  
  // Property Classification (RESO format)
  propertyType           PropertyType  // Primary classification
  propertySubType        PropertySubType? // More specific classification
  status                 ListingStatus @default(Active) // RESO: Current listing status
  
  // Location Information (RESO format)
  streetNumber         String        @db.VarChar(25)  // RESO: Street number component
  streetName           String        @db.VarChar(50)  // RESO: Street name component
  unitNumber           String?       @db.VarChar(25)  // RESO: Unit/apartment number
  city                 String        @db.VarChar(150) // RESO: City name
  stateOrProvince      String        @db.VarChar(50)  // RESO: State/province
  postalCode           String        @db.VarChar(10)  // RESO: Postal/ZIP code
  
  // Price Information (RESO format)
  listPrice            Decimal       @db.Decimal(12,2) // RESO: Current listing price
  originalListPrice    Decimal?      @db.Decimal(12,2) // RESO: Original price when listed
  closePrice             Decimal?      @db.Decimal(12,2) // RESO: Final sale price
  
  // Dates and Timestamps (RESO format)
  listingContractDate  DateTime?   @db.Timestamptz  // RESO: Contract start date
  closeDate            DateTime?   @db.Timestamptz  // RESO: Property closing date
  statusChangeTimestamp DateTime? @db.Timestamptz  // RESO: Last status change
  priceChangeTimestamp   DateTime? @db.Timestamptz  // RESO: Last price change
  modificationTimestamp DateTime? @db.Timestamptz  // RESO: Last modification
  createdAt            DateTime   @default(now()) @db.Timestamptz
  updatedAt            DateTime   @updatedAt @db.Timestamptz
  
  // Physical Characteristics (RESO format)
  bedroomsTotal        Int?         // RESO: Total number of bedrooms
  bathroomsTotal       Decimal?     @db.Decimal(3,1) // RESO: Total bathrooms (allows half baths)
  livingArea           Decimal?     @db.Decimal(12,2) // RESO: Living space square footage
  lotSize              Decimal?     @db.Decimal(12,2) // RESO: Lot size in square feet
  lotSizeDimensions    String?      @db.VarChar(50)  // RESO: Actual lot dimensions
  lotDimensionsSource  String?    @db.VarChar(50)  // RESO: Source of dimension data
  yearBuilt            Int?         // RESO: Year property was built
  stories              Int?         // RESO: Number of stories/levels
  
  // Structural Details (RESO format)
  architecturalStyle   ArchitecturalStyle? // RESO: Architectural style
  basement             BasementType?     // RESO: Basement type
  roofType             RoofType?         // RESO: Type of roof
  view                 ViewType[]        // RESO: Available views
  
  // Parking Information (RESO format)
  parkingTotal         Decimal?     @db.Decimal(12,2) // RESO: Total parking spaces
  garageSpaces         Decimal?     @db.Decimal(12,2) // RESO: Garage spaces
  
  // Property Features (RESO format)
  furnished            FurnishedStatus? // RESO: Furnishing status
  appliances           String[]        // RESO: Available appliances
  interiorFeatures     String[]        // RESO: Interior features
  exteriorFeatures     String[]        // RESO: Exterior features
  heating              String[]        // RESO: Heating systems
  cooling              String[]        // RESO: Cooling systems
  
  // Property Amenities (RESO format)
  isWaterfront         Boolean        @default(false) // RESO: Waterfront property
  hasFireplace         Boolean        @default(false) // RESO: Fireplace present
  hasPatio             Boolean        @default(false) // RESO: Patio present
  hasDeck              Boolean        @default(false) // RESO: Deck present
  hasPorch             Boolean        @default(false) // RESO: Porch present
  
  // Property Condition and Terms (RESO format)
  propertyCondition    PropertyCondition[] // RESO: Current condition
  listingTerms         ListingTerms[]     // RESO: Acceptable terms
  listingAgreement     ListingAgreement?  // RESO: Type of listing agreement
  
  // Community Information (RESO format)
  schoolDistrict       String?       @db.VarChar(100) // RESO: School district name
  elementarySchool     String?       @db.VarChar(100) // RESO: Elementary school
  middleSchool         String?       @db.VarChar(100) // RESO: Middle school
  highSchool             String?       @db.VarChar(100) // RESO: High school
  
  // Financial Information (RESO format)
  taxYear              Int?         // RESO: Tax assessment year
  taxAnnualAmount      Decimal?     @db.Decimal(12,2) // RESO: Annual tax amount
  hoaName              String?      @db.VarChar(100)  // RESO: HOA name
  hoaFeeAmount         Decimal?     @db.Decimal(12,2) // RESO: HOA fee amount
  hoaFeeFrequency      String?      @db.VarChar(50)   // RESO: HOA payment frequency
  
  // Utilities (RESO format)
  electricityAvailable Boolean    @default(true) // RESO: Electricity status
  gasAvailable           Boolean    @default(true) // RESO: Gas status
  sewerAvailable         Boolean    @default(true) // RESO: Sewer status
  waterAvailable         Boolean    @default(true) // RESO: Water status
  
  // Zoning Information (RESO format)
  zoning               String?     @db.VarChar(25)  // RESO: Zoning code
  zoningDescription  String?     @db.VarChar(255) // RESO: Zoning description
  
  // Marketing Information (RESO format)
  publicRemarks       String?     @db.VarChar(4000) // RESO: Public description
  privateRemarks      String?     @db.VarChar(4000) // RESO: Agent-only remarks
  photos               Json?       // RESO: Property photos
  virtualTours         Json?       // RESO: Virtual tour links
  isFeatured           Boolean     @default(false)   // Custom: Featured listing flag
  featuredOrder        Int?        // Custom: Featured listing order

  // Custom fields
  mlsLink              String?     @db.VarChar(1000) // Custom: Direct link to MLS listing
  publicListingUrl     String?     @db.VarChar(1000) // Custom: Link to public listing (Zillow, Redfin, etc.)
  
  // Source Information (RESO format)
  source               String     @default("MANUAL") // RESO: Data source
  mlsSource            String?    // RESO: MLS system name
  mlsId                String?    // RESO: MLS-specific ID
  
  // Relations
  realtorProfileUlid      String   @db.Char(26)
  realtorProfile        RealtorProfile @relation(fields: [realtorProfileUlid], references: [ulid], onDelete: Cascade)
  
  // Indexes for performance
  @@index([realtorProfileUlid])
  @@index([listingKey])
  @@index([status])
  @@index([isFeatured])
  @@map("Listing")
}

// AI Chat Models
model AIThread {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  userUlid               String   @db.Char(26)
  title                  String
  category               String
  status                 String     @default("ACTIVE")
  messages               AIMessage[]
  createdAt              DateTime   @default(now()) @db.Timestamptz
  updatedAt              DateTime   @updatedAt @db.Timestamptz

  // Relations
  user                   User       @relation(fields: [userUlid], references: [ulid], onDelete: Cascade)

  @@index([userUlid])
  @@map("AIThread")
}

model AIMessage {
  ulid                   String   @id @db.Char(26) @default(dbgenerated("generate_ulid()"))
  threadUlid             String   @db.Char(26)
  role                   String   // user or assistant
  content                String   @db.Text
  model                  String   // e.g., gpt-4
  tokens                 Int      @default(0)
  createdAt              DateTime @default(now()) @db.Timestamptz
  updatedAt              DateTime @updatedAt @db.Timestamptz

  // Relations
  thread                 AIThread @relation(fields: [threadUlid], references: [ulid], onDelete: Cascade)

  @@index([threadUlid])
  @@map("AIMessage")
}
